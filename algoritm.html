<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MVP-v1 • Алгоритм подбора слов и оценки уровня</title>
<style>
 body{font-family:Arial,Helvetica,sans-serif;line-height:1.55;max-width:1080px;margin:24px auto;
      padding:0 20px;background:#fdfdfd;color:#222}
 h1,h2,h3,h4{color:#2c3e50;margin:1.2em 0 .4em}
 h1{font-size:1.9em;margin-top:.4em}
 table{border-collapse:collapse;width:100%;margin:14px 0}
 th,td{border:1px solid #bbb;padding:7px 10px;text-align:left}
 th{background:#ecf0f1}
 code{background:#f0f0f0;padding:2px 5px;border-radius:3px;font-family:Consolas,monospace}
 pre{background:#f0f0f0;padding:10px;border-radius:4px;overflow-x:auto}
 .note{color:#666;font-style:italic}
 ul{margin-top:0}
 .highlight{background-color:#ffeeba;padding:2px}
</style>
</head>
<body>

<h1>MVP v1 · Полная спецификация<br>алгоритма подбора слов и оценки уровня</h1>

<p class="note">Документ предназначен для ТЗ / Confluence. Он объединяет бизнес-правила, алгоритмы,
архитектурное разбиение на модули и потоки их взаимодействия. Все числовые параметры
отмечены «*» — конфигурируемы.</p>

<!-- 1 -->
<h2>1. Основные параметры и конфигурация</h2>
<table>
<thead><tr><th>Параметр</th><th>Значение по умолчанию</th><th>Комментарий</th></tr></thead>
<tbody>
<tr><td>Стартовый уровень</td><td>A2 (difficulty=2)</td><td>Начальная сложность слов</td></tr>
<tr><td>Размер сессии</td><td>10 слов</td><td>Сколько слов показываем за один проход</td></tr>
<tr><td>Временной карантин</td><td>5 мин*</td><td>Запрет повторять слово внутри сессии (кроме Weak)</td></tr>
<tr><td>«Длинный» перерыв</td><td>14 дней*</td><td>После паузы &gt;14 дн. — заморозка уровня 2 сессии</td></tr>
<tr><td>Вес сессий WSR</td><td>3 : 2 : 1*</td><td>Взвешивание 3 последних сессий</td></tr>
<tr><td>Порог повышения</td><td>≥ 85 %* (3 сессии)</td><td>Для level +1</td></tr>
<tr><td>Порог понижения</td><td>&lt; 55 %* (3 сессии)</td><td>Для level –1 (но ≥ A1)</td></tr>
<tr><td>Макс. новых/сессию</td><td>5*</td><td>Лимит New-L (адаптивно на основе успеваемости)</td></tr>
<tr><td class="highlight">Интервалы повторения</td><td class="highlight">1/7/30 дней*</td><td class="highlight">Короткий/средний/длинный интервал</td></tr>
<tr><td class="highlight">Порог weak слов</td><td class="highlight">50%*</td><td class="highlight">Снижен для лучшей адаптации</td></tr>
<tr><td class="highlight">Порог review слов</td><td class="highlight">70%*</td><td class="highlight">С запасными порогами и гибкой логикой</td></tr>
</tbody></table>

<!-- 2 -->
<h2>2. Категории слов</h2>
<table>
<thead><tr><th>Категория</th><th>Условие (упрощённо)</th><th>Назначение</th></tr></thead>
<tbody>
<tr><td>Weak</td><td><code>difficulty=L AND (success_rate&lt;0.5 OR last_answer_wrong)</code></td><td>Закрепляем слабые слова</td></tr>
<tr><td>New-L</td><td><code>difficulty=L AND repeats=0</code></td><td>Добавляем новые на текущем уровне</td></tr>
<tr><td>Review</td><td><code>difficulty=L AND success_rate≥0.7 AND (now-last_seen)≥interval_short</code></td><td>Spaced-repetition</td></tr>
<tr><td>Stretch+1</td><td><code>difficulty=L+1 AND (repeats=0 OR due)</code></td><td>Вызов вверх</td></tr>
<tr><td>Patch-1</td><td><code>difficulty=L-1 AND (repeats=0 OR due_long)</code></td><td>Заплатка базовых слов</td></tr>
<tr><td class="highlight">Fallback</td><td class="highlight"><code>Слова, выбираемые по смягченным критериям</code></td><td class="highlight">Гарантия заполнения сессии</td></tr>
</tbody></table>
<p class="note">interval_short = 1 день*, interval_medium = 7 дней*, interval_long = 30 дней*.</p>

<!-- 3 -->
<h2>3. Подбор 10 слов в сессию</h2>

<h3>3.1 Распределение слов по категориям</h3>
<table>
<thead><tr><th>Категория</th><th>Мин.</th><th>Макс.</th><th>Цель</th><th class="highlight">Приоритет</th></tr></thead>
<tbody>
<tr><td>Weak</td><td>0</td><td>3</td><td>2-3</td><td class="highlight">Высокий</td></tr>
<tr><td>New-L</td><td>1</td><td>5*</td><td>Зависит от success_rate</td><td class="highlight">Средний/Высокий</td></tr>
<tr><td>Review</td><td>0</td><td>3</td><td>2-3</td><td class="highlight">Средний</td></tr>
<tr><td>Stretch+1</td><td>1</td><td>2</td><td>1-2</td><td class="highlight">Средний/Низкий</td></tr>
<tr><td>Patch-1</td><td>0</td><td>1</td><td>1</td><td class="highlight">Низкий</td></tr>
</tbody></table>

<h3>3.2 Общий алгоритм</h3>

<ol>
<li>Предварительно собираем пул слов по каждой категории
  <ul>
    <li>Weak: слова с низким success_rate (< 50%*)</li>
    <li>Review: давно не виденные слова с хорошим success_rate (≥ 70%*)</li>
    <li>New-L: новые слова текущего уровня</li>
    <li>Stretch+1: слова уровня +1</li>
    <li>Patch-1: слова уровня -1</li>
  </ul>
</li>
<li class="highlight">Если какая-то категория не заполняется - применяем каскадный fallback:
  <ul>
    <li>Для Weak: последовательно смягчаем порог success_rate (50% → 65% → 80%*)</li>
    <li>Для Review: пробуем разные временные интервалы (1 день → 7 дней → 30 дней*)</li>
    <li>Для New-L: ищем в других уровнях (текущий → +1 → -1)</li>
  </ul>
</li>
<li>Распределяем слова в оптимальных пропорциях:
  <ul>
    <li>Для начинающих: больше Weak и Review, меньше новых</li>
    <li>Для продвинутых: больше новых и Stretch+1, меньше Weak</li>
  </ul>
</li>
<li class="highlight">Если сессия не заполнена, запускаем механизм гарантированного заполнения:
  <ul>
    <li>Стратегия 1: Оставшиеся слова из собранных категорий</li>
    <li>Стратегия 2: Любые слова по давности просмотра</li>
    <li>Стратегия 3: Случайные слова целевого языка</li>
  </ul>
</li>
</ol>

<h3>3.3 Адаптивный выбор новых слов</h3>
<table>
<thead><tr><th>Recent Success Rate</th><th>Количество новых слов</th></tr></thead>
<tbody>
<tr><td>< 40%*</td><td>1</td></tr>
<tr><td>40-60%*</td><td>2</td></tr>
<tr><td>60-80%*</td><td>4</td></tr>
<tr><td>> 80%*</td><td>5</td></tr>
</tbody></table>

<h3>3.4 Общие правила</h3>
<ul>
<li>Карантин 5 мин: слово (кроме Weak) не повторяется в сессии.</li>
<li>Список после формирования перемешивается.</li>
<li class="highlight">Сессия всегда заполняется 10 словами благодаря многоуровневым fallback-стратегиям.</li>
</ul>

<!-- 4 -->
<h2>4. Онбординг (первые две сессии)</h2>

<table>
<thead><tr><th>Сессия</th><th>Состав&nbsp;10 слов</th><th>Жёсткие правила</th></tr></thead>
<tbody>
<tr>
<td>1</td>
<td>
  <ul>
    <li>5&nbsp;частотных A1 (<em>Easy-A1</em>)</li>
    <li>5&nbsp;новых A2 (<em>New-A2</em>)</li>
  </ul>
</td>
<td>Уровень фиксирован, WSR лишь копится</td>
</tr>
<tr>
<td>2</td>
<td>
  <ul>
    <li>3–4&nbsp;слова из сессии-1 (learning)</li>
    <li>3–4&nbsp;новых A2</li>
    <li>0–2&nbsp;легких A1 при нехватке</li>
  </ul>
</td>
<td>Уровень всё ещё заблокирован;<br>с 3-ей сессии включается общий алгоритм</td>
</tr>
</tbody></table>

<!-- 5 -->
<h2>5. Механика обработки ответа</h2>
<ol>
<li><code>repeats += 1</code></li>
<li><code>successes += 1</code> (если ответ верен)</li>
<li><code>success_rate = successes / repeats</code></li>
<li><code>last_seen = now()</code></li>
<li><code>last_answer_wrong</code> — флаг результата</li>
</ol>

<!-- 6 -->
<h2>6. Пересчёт уровня (после сессии)</h2>
<p>Берём 3 последние сессии (≤ 30 ответов):</p>
<pre>WSR = (S₀×3 + S₁×2 + S₂×1) / 6</pre>
<ul>
<li>3 × подряд WSR ≥ 85 % → level +1</li>
<li>3 × подряд WSR &lt; 55 % → level –1 (min A1)</li>
<li>Перерыв &gt; 14 дней → уровень заморожен 2 сессии, Patch-1 = 3 слова</li>
</ul>

<!-- 7 -->
<h2>7. Пограничные ситуации</h2>
<table>
<thead><tr><th>Ситуация</th><th class="highlight">Решение</th></tr></thead>
<tbody>
<tr><td>Пул Weak пуст</td><td class="highlight">Смягчение пороговых значений до 65%, затем до 80%</td></tr>
<tr><td>Нет слов для повторения</td><td class="highlight">Поиск слов по последовательно увеличивающимся периодам давности (1/7/30 дней)</td></tr>
<tr><td>Нет New-L</td><td class="highlight">Поиск в соседних уровнях сложности</td></tr>
<tr><td>Недостаточно слов для сессии</td><td class="highlight">Многоуровневая стратегия заполнения: остаток из пула → сортировка по давности → случайные слова</td></tr>
<tr><td>Level = A1, Patch-1 отсутствует</td><td>Слот Patch-1 → дополнительные New-L или Review</td></tr>
<tr><td>Level = C2, Stretch отсутствует</td><td>Слот Stretch → дополнительные New-L или Review</td></tr>
<tr><td>Успешный пользователь (>80%)</td><td class="highlight">Увеличение доли новых слов (до 5) и слов повышенной сложности (до 2)</td></tr>
<tr><td>Дубликат слова в сессии</td><td>Удаляем дубликат, берём слово той же категории</td></tr>
</tbody></table>

<!-- 8 -->
<h2>8. Архитектура модулей монолита (MVP)</h2>

<h3>8.1 Модули и зоны ответственности</h3>
<table>
<thead><tr><th>Модуль</th><th>Функция</th><th>Вызывает / API</th></tr></thead>
<tbody>
<tr><td><strong>config.py</strong></td><td>Читает параметры (JSON/BД); отдаёт константы</td><td>Все модули</td></tr>
<tr><td><strong>db_access.py</strong></td><td>ORM/SQL; транзакции; кеш</td><td>Все бизнес-модули</td></tr>
<tr><td><strong>onboarding.py</strong></td><td>Формирует слова для первых 2 сессий</td><td>Контроллер сессии</td></tr>
<tr><td><strong>picker.py</strong></td><td>Подбор 10 слов (§3)</td><td>Контроллер сессии</td></tr>
<tr><td><strong>answer_handler.py</strong></td><td>Записывает результат ответа, обновляет статистику</td><td>Endpoint «Ответить»</td></tr>
<tr><td><strong>session_evaluator.py</strong></td><td>Считает WSR, меняет уровень</td><td>После 10 ответов</td></tr>
</tbody></table>

<h3>8.2 Поток вызовов</h3>
<ol>
<li><strong>start‐session</strong> → <code>onboarding | picker</code> → 10 слов</li>
<li><strong>answer</strong> → <code>answer_handler</code> (update DB)</li>
<li><strong>finish‐session</strong> → <code>session_evaluator</code> (WSR→level)</li>
</ol>

<!-- 9 -->
<h2>9. Преимущества решения</h2>
<ul>
<li>Баланс слабых/новых/повторения — адаптивно к успеху.</li>
<li>Плавное изменение уровня без резких падений.</li>
<li>Гибкая настройка всех порогов.</li>
<li>Мягкий онбординг — пользователь быстро видит прогресс.</li>
<li class="highlight">Гарантированное формирование полноценной сессии из 10 слов при любых условиях.</li>
<li class="highlight">Улучшенное распределение слов для опытных пользователей с высоким success rate.</li>
<li class="highlight">Многоуровневые fallback-стратегии для обработки любых краевых случаев.</li>
<li class="highlight">Динамическая настройка количества новых слов в зависимости от успеваемости пользователя.</li>
<li>Чёткое разделение модулей — готово к миграции в микросервисы.</li>
</ul>

<hr>
<p class="note">Документ обновлен с учётом последних улучшений алгоритма. Выделены <span class="highlight">ключевые изменения</span> и дополнения.</p>

</body>
</html> 